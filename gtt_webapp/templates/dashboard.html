{% extends 'base.html' %}

{% block title %}Dashboard - GTT Orders{% endblock %}

{% block content %}
<div class="content-wrapper">
    <!-- Main header with actions -->
    <div class="page-header">
        <div>
            <h2>
                <i class="fas fa-chart-line"></i>GTT Orders Dashboard
            </h2>
        </div>
        <div class="btn-toolbar">
            <button type="button" class="btn btn-outline-primary btn-sm" data-bs-toggle="modal" data-bs-target="#createOrderModal">
                <i class="fas fa-plus me-1"></i>New GTT Order
            </button>
            <button type="button" class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#multiGttModal">
                <i class="fas fa-layer-group me-1"></i>Multi GTT Orders
            </button>
        </div>
    </div>

    <!-- Controls bar for search and length -->
    <div class="controls-bar">
        <div class="control-group">
            <!-- Search -->
            <div class="input-group input-group-sm search-input-group">
                <span class="input-group-text">
                    <i class="fas fa-search"></i>
                </span>
                <input type="text" class="form-control" id="dashboardSearch" placeholder="Search table...">
            </div>
            <!-- Length selector -->
            <select class="form-select form-select-sm compact-select" id="dashboardLength">
                <option value="10">10</option>
                <option value="25" selected>25</option>
                <option value="50">50</option>
                <option value="100">100</option>
                <option value="-1">All</option>
            </select>
        </div>
    </div>

    {% if error %}
    <div class="alert alert-warning py-2" style="font-size: 0.875rem;">
        <i class="fas fa-exclamation-triangle me-2"></i>
        Unable to connect to KiteConnect. Please make sure:
        <ol class="mb-0 mt-2">
            <li>You have run AutoConnect.py to generate access_token.txt</li>
            <li>Your access token is valid and not expired</li>
            <li>You have proper internet connectivity</li>
        </ol>
    </div>
    {% endif %}

    <!-- Main table -->
    <div class="table-wrapper">
        <div class="d-flex justify-content-end px-3 py-2 border-bottom bg-light">
            <div class="text-muted" style="font-size: 0.875rem;">
                <strong class="me-3">Sum of BUY Amount: ₹<span id="sumBuyAmount">0.00</span></strong>
                <strong>Sum of SELL Amount: ₹<span id="sumSellAmount">0.00</span></strong>
            </div>
        </div>
        <div class="table-responsive">
            <table class="table table-hover table-compact" id="ordersTable">
                <thead>
                    <tr>
                        <th>Symbol</th>
                        <th>Exchange</th>
                        <th>Type</th>
                        <th>Trigger Values</th>
                        <th>Last Price</th>
                        <th>Transaction</th>
                        <th>Quantity</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for order in orders %}
                    <tr>
                        <td>{{ order.condition.tradingsymbol }}</td>
                        <td>{{ order.condition.exchange }}</td>
                        <td>{{ order.type }}</td>
                        <td>{{ ', '.join(order.condition.trigger_values|map('string')) }}</td>
                        <td>{{ order.condition.last_price }}</td>
                        <td>
                            <span class="badge bg-{{ 'success' if order.orders[0].transaction_type == 'BUY' else 'danger' }}">
                                {{ order.orders[0].transaction_type }}
                        </span>
                        </td>
                        <td>{{ order.orders[0].quantity }}</td>
                        <td>
                            <span class="badge bg-{{ {
                                'active': 'primary',
                                'triggered': 'success',
                                'cancelled': 'warning',
                                'rejected': 'danger',
                                'deleted': 'secondary'
                            }[order.status] }}">
                                {{ order.status }}
                            </span>
                        </td>
                        <td>
                            <div class="btn-group">
                                <a href="{{ url_for('main.order_detail', trigger_id=order.id) }}" 
                                   class="btn btn-sm btn-info" title="View">
                                    <i class="fas fa-eye"></i>
                                </a>
                                <a href="{{ url_for('main.edit_order', trigger_id=order.id) }}" 
                                   class="btn btn-sm btn-warning" title="Edit">
                                    <i class="fas fa-edit"></i>
                                </a>
                                <button onclick="deleteOrder({{ order.id }})" 
                                        class="btn btn-sm btn-danger" title="Delete">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Create Order Modal -->
<div class="modal fade" id="createOrderModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Create New GTT Order</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="createOrderForm">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Trading Symbol</label>
                                <input type="text" class="form-control" name="tradingsymbol" required>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Exchange</label>
                                <select class="form-select" name="exchange" required>
                                    <option value="NSE">NSE</option>
                                    <option value="BSE">BSE</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Trigger Type</label>
                                <select class="form-select" name="trigger_type" required>
                                    <option value="single">Single</option>
                                    <option value="two-leg">Two-Leg</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Trigger Values</label>
                                <input type="text" class="form-control" name="trigger_values" id="triggerValuesInput" required>
                                <small class="form-text text-muted" style="font-size: 0.85em;">Single: one value. Two-leg: comma separated. Used for price calculation.</small>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Last Price</label>
                                <input type="number" step="0.01" class="form-control" name="last_price" id="lastPriceInput" required>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Amount to Invest</label>
                                <input type="number" step="0.01" class="form-control" name="amount_to_invest" id="amountToInvestInput" placeholder="Amount">
                                <small class="form-text text-muted" style="font-size: 0.85em;">Enter amount or quantity. Both fields auto-update using trigger value.</small>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Transaction Type</label>
                                <select class="form-select" name="transaction_type" required>
                                    <option value="BUY">BUY</option>
                                    <option value="SELL">SELL</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Quantity</label>
                                <input type="number" class="form-control" name="quantity" id="quantityInput" required>
                                <small class="form-text text-muted" style="font-size: 0.85em;">Amount and quantity are linked.</small>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="createOrder()">Create Order</button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<!-- DataTables and jQuery (add CDN if not already included in base.html) -->
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://cdn.datatables.net/1.13.7/js/jquery.dataTables.min.js"></script>
<link rel="stylesheet" href="https://cdn.datatables.net/1.13.7/css/jquery.dataTables.min.css" />
<script>
$(document).ready(function() {
    // Initialize DataTable
    let dashboardTable = $('#ordersTable').DataTable({
        order: [[0, 'asc']],
        pageLength: 25,
        autoWidth: false,
        dom: 'rtip',
    });
    // Search
    $('#dashboardSearch').on('keyup', function() {
        dashboardTable.search(this.value).draw();
    });
    // Page length
    $('#dashboardLength').on('change', function() {
        let val = parseInt($(this).val());
        dashboardTable.page.len(val).draw();
    });
});
</script>
<script src="{{ url_for('static', filename='js/gtt-orders.js') }}"></script>
<script>
function createOrder() {
    const form = document.getElementById('createOrderForm');
    const formData = new FormData(form);
    const data = Object.fromEntries(formData.entries());
    // Remove amount_to_invest from payload (not needed by backend)
    delete data.amount_to_invest;
    fetch('/api/gtt/order', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        if (data.error) {
            alert('Error: ' + data.error);
        } else {
            location.reload();
        }
    })
    .catch(error => {
        alert('Error: ' + error);
    });
}

function deleteOrder(orderId) {
    if (confirm('Are you sure you want to delete this order?')) {
        fetch(`/api/gtt/order/${orderId}`, {
            method: 'DELETE'
        })
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                alert('Error: ' + data.error);
            } else {
                location.reload();
            }
        })
        .catch(error => {
            alert('Error: ' + error);
        });
    }
}

function createMultiGttOrders() {
    const form = document.getElementById('multiGttForm');
    const formData = new FormData(form);
    const data = Object.fromEntries(formData.entries());
    // Parse orders_json as JSON
    try {
        data.orders_json = JSON.parse(data.orders_json);
    } catch (e) {
        return alert('Invalid JSON in orders_json field');
    }
    fetch('/api/gtt/orders', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        if (data.error) {
            alert('Error: ' + data.error);
        } else {
            location.reload();
        }
    })
    .catch(error => {
        alert('Error: ' + error);
    });
}

// Density control logic is now in static/js/script.js

// --- Quantity auto-calc logic ---
const amountInput = document.getElementById('amountToInvestInput');
const triggerValuesInput = document.getElementById('triggerValuesInput');
const quantityInput = document.getElementById('quantityInput');

function getFirstTriggerValue() {
    if (!triggerValuesInput) return NaN;
    const val = triggerValuesInput.value.split(',')[0].trim();
    return parseFloat(val);
}
function updateQuantityFromAmount() {
    const amount = parseFloat(amountInput.value);
    const price = getFirstTriggerValue();
    if (!isNaN(amount) && !isNaN(price) && price > 0) {
        quantityInput.value = Math.floor(amount / price);
    }
}
function updateAmountFromQuantity() {
    const qty = parseFloat(quantityInput.value);
    const price = getFirstTriggerValue();
    if (!isNaN(qty) && !isNaN(price) && price > 0) {
        amountInput.value = (qty * price).toFixed(2);
    }
}
if (amountInput && triggerValuesInput && quantityInput) {
    amountInput.addEventListener('input', updateQuantityFromAmount);
    triggerValuesInput.addEventListener('input', function() {
        updateQuantityFromAmount();
        updateAmountFromQuantity();
    });
    quantityInput.addEventListener('input', updateAmountFromQuantity);
}

function calculateOrderAmounts() {
    let sumBuy = 0, sumSell = 0;
    document.querySelectorAll('#ordersTable tbody tr').forEach(row => {
        const txnCell = row.querySelector('td:nth-child(6) .badge');
        const qtyCell = row.querySelector('td:nth-child(7)');
        const priceCell = row.querySelector('td:nth-child(5)');
        if (!txnCell || !qtyCell || !priceCell) return;
        const txn = txnCell.textContent.trim();
        const qty = parseFloat(qtyCell.textContent);
        const price = parseFloat(priceCell.textContent);
        if (isNaN(qty) || isNaN(price)) return;
        const amt = qty * price;
        if (txn === 'BUY') sumBuy += amt;
        if (txn === 'SELL') sumSell += amt;
    });
    document.getElementById('sumBuyAmount').textContent = sumBuy.toFixed(2);
    document.getElementById('sumSellAmount').textContent = sumSell.toFixed(2);
}
document.addEventListener('DOMContentLoaded', function() {
    calculateOrderAmounts();
});
</script>
{% endblock %}

{% include 'multi_gtt_modal.html' %}
