{% extends 'base.html' %}

{% block title %}Dashboard - GTT Orders{% endblock %}

{% block styles %}
{{ super() }}
<link rel="stylesheet" href="{{ url_for('static', filename='css/custom-gtt.css') }}">
<style>
/* Dashboard-specific table styling to match custom-gtt */
.table-responsive #ordersTable {
    table-layout: fixed !important;
    width: 100% !important;
    border-collapse: collapse;
}

.table-responsive #ordersTable th,
.table-responsive #ordersTable td {
    vertical-align: middle !important;
    padding: 0.15rem 0.1rem !important;
    border: 0.5px solid #dee2e6;
    font-size: 0.85rem;
    line-height: 1;
}

/* Column widths for dashboard table */
.table-responsive #ordersTable thead th:nth-child(1),
.table-responsive #ordersTable tbody td:nth-child(1) { 
    width: 90px !important; 
    min-width: 90px !important;
    max-width: 90px !important;
    font-weight: 600;
}

.table-responsive #ordersTable thead th:nth-child(2),
.table-responsive #ordersTable tbody td:nth-child(2) { 
    width: 60px !important; 
    min-width: 60px !important;
    max-width: 60px !important;
    text-align: center;
}

.table-responsive #ordersTable thead th:nth-child(3),
.table-responsive #ordersTable tbody td:nth-child(3) { 
    width: 50px !important; 
    min-width: 50px !important;
    max-width: 50px !important;
    text-align: center;
}

.table-responsive #ordersTable thead th:nth-child(4),
.table-responsive #ordersTable tbody td:nth-child(4) { 
    width: 120px !important; 
    min-width: 120px !important;
    max-width: 120px !important;
    text-align: center;
}

.table-responsive #ordersTable thead th:nth-child(5),
.table-responsive #ordersTable tbody td:nth-child(5) { 
    width: 80px !important; 
    min-width: 80px !important;
    max-width: 80px !important;
    text-align: right;
}

.table-responsive #ordersTable thead th:nth-child(6),
.table-responsive #ordersTable tbody td:nth-child(6) { 
    width: 80px !important; 
    min-width: 80px !important;
    max-width: 80px !important;
    text-align: center;
}

.table-responsive #ordersTable thead th:nth-child(7),
.table-responsive #ordersTable tbody td:nth-child(7) { 
    width: 60px !important; 
    min-width: 60px !important;
    max-width: 60px !important;
    text-align: right;
}

.table-responsive #ordersTable thead th:nth-child(8),
.table-responsive #ordersTable tbody td:nth-child(8) { 
    width: 100px !important; 
    min-width: 100px !important;
    max-width: 100px !important;
    text-align: right;
}

.table-responsive #ordersTable thead th:nth-child(9),
.table-responsive #ordersTable tbody td:nth-child(9) { 
    width: 80px !important; 
    min-width: 80px !important;
    max-width: 80px !important;
    text-align: center;
}

.table-responsive #ordersTable thead th:nth-child(10),
.table-responsive #ordersTable tbody td:nth-child(10) { 
    width: 120px !important; 
    min-width: 120px !important;
    max-width: 120px !important;
    text-align: center;
}

/* Sortable headers styling */
.sortable {
    cursor: pointer;
    position: relative;
    user-select: none;
}

.sortable:hover {
    background-color: #f8f9fa;
}

.sort-icon {
    margin-left: 5px;
    opacity: 0.6;
    font-size: 0.7rem;
}

.sortable.sort-asc .sort-icon:before {
    content: "\f0de"; /* fa-sort-up */
    color: #007bff;
    opacity: 1;
}

.sortable.sort-desc .sort-icon:before {
    content: "\f0dd"; /* fa-sort-down */
    color: #007bff;
    opacity: 1;
}

/* Controls bar styling */
.controls-bar {
    display: flex;
    align-items: center;
    gap: 1rem;
    padding: 1rem;
    background-color: #f8f9fa;
    border: 1px solid #dee2e6;
    border-radius: 0.375rem;
    margin-bottom: 1rem;
    flex-wrap: wrap;
}

.controls-bar .form-select,
.controls-bar .form-control {
    min-width: 150px;
}

.search-input-group {
    flex: 1;
    max-width: 300px;
}

.compact-select {
    min-width: 120px !important;
}
</style>
{% endblock %}

{% block content %}
<div class="content-wrapper">
    <!-- Main header with actions -->
    <div class="page-header">
        <div>
            <h2>
                <i class="fas fa-chart-line"></i>GTT Orders Dashboard
            </h2>
        </div>
        <div class="btn-toolbar">
            <button type="button" class="btn btn-outline-primary btn-sm" data-bs-toggle="modal" data-bs-target="#createOrderModal">
                <i class="fas fa-plus me-1"></i>New GTT Order
            </button>
            <button type="button" class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#multiGttModal">
                <i class="fas fa-layer-group me-1"></i>Multi GTT Orders
            </button>
        </div>
    </div>

    <!-- Controls bar for search, filters and length -->
    <div class="controls-bar">
        <!-- Search -->
        <div class="input-group input-group-sm search-input-group">
            <span class="input-group-text">
                <i class="fas fa-search"></i>
            </span>
            <input type="text" class="form-control" id="dashboardSearch" placeholder="Search orders...">
        </div>
        
        <!-- Transaction Type Filter -->
        <select class="form-select form-select-sm compact-select" id="transactionFilter">
            <option value="">All Types</option>
            <option value="BUY">BUY</option>
            <option value="SELL">SELL</option>
        </select>
        
        <!-- Status Filter -->
        <select class="form-select form-select-sm compact-select" id="statusFilter">
            <option value="">All Status</option>
            <option value="active">Active</option>
            <option value="triggered">Triggered</option>
            <option value="cancelled">Cancelled</option>
            <option value="rejected">Rejected</option>
            <option value="deleted">Deleted</option>
        </select>
        
        <!-- Exchange Filter -->
        <select class="form-select form-select-sm compact-select" id="exchangeFilter">
            <option value="">All Exchanges</option>
            <option value="NSE">NSE</option>
            <option value="BSE">BSE</option>
        </select>
        
        <!-- Records per page -->
        <select class="form-select form-select-sm compact-select" id="dashboardLength">
            <option value="10">10</option>
            <option value="25">25</option>
            <option value="50">50</option>
            <option value="100">100</option>
            <option value="-1" selected>All</option>
        </select>
        
        <!-- Refresh button -->
        <button type="button" class="btn btn-sm btn-outline-secondary" id="refreshTable" title="Refresh">
            <i class="fas fa-sync-alt"></i>
        </button>
    </div>

    {% if error %}
    <div class="alert alert-warning py-2" style="font-size: 0.875rem;">
        <i class="fas fa-exclamation-triangle me-2"></i>
        Unable to connect to KiteConnect. Please make sure:
        <ol class="mb-0 mt-2">
            <li>You have run AutoConnect.py to generate access_token.txt</li>
            <li>Your access token is valid and not expired</li>
            <li>You have proper internet connectivity</li>
        </ol>
    </div>
    {% endif %}

    <!-- Main table -->
    <div class="table-wrapper">
        <!-- Order Summary Section -->
        <div class="order-summary-bar d-flex justify-content-between align-items-center px-3 py-2 border-bottom bg-light">
            <div class="text-muted" style="font-size: 0.875rem;">
                <span id="orderCountDisplay">Loading orders...</span>
            </div>
            <div class="d-flex gap-4" style="font-size: 0.875rem;">
                <div class="buy-total">
                    <strong class="text-success">
                        <i class="fas fa-arrow-up me-1"></i>
                        BUY: ₹<span id="totalBuyAmount">0.00</span>
                    </strong>
                </div>
                <div class="sell-total">
                    <strong class="text-danger">
                        <i class="fas fa-arrow-down me-1"></i>
                        SELL: ₹<span id="totalSellAmount">0.00</span>
                    </strong>
                </div>
                <div class="net-total">
                    <strong class="text-info">
                        <i class="fas fa-calculator me-1"></i>
                        NET: ₹<span id="netAmount">0.00</span>
                    </strong>
                </div>
            </div>
        </div>
        </div>
        <div class="table-responsive">
            <table class="table table-hover table-compact" id="ordersTable">
                <thead>
                    <tr>
                        <th class="sortable" data-column="symbol">
                            Symbol <i class="fas fa-sort sort-icon"></i>
                        </th>
                        <th class="sortable" data-column="exchange">
                            Exch <i class="fas fa-sort sort-icon"></i>
                        </th>
                        <th class="sortable" data-column="type">
                            Type <i class="fas fa-sort sort-icon"></i>
                        </th>
                        <th class="sortable" data-column="trigger_values">
                            Trigger Values <i class="fas fa-sort sort-icon"></i>
                        </th>
                        <th class="sortable" data-column="last_price">
                            Last Price <i class="fas fa-sort sort-icon"></i>
                        </th>
                        <th class="sortable" data-column="transaction_type">
                            Transaction <i class="fas fa-sort sort-icon"></i>
                        </th>
                        <th class="sortable" data-column="quantity">
                            Qty <i class="fas fa-sort sort-icon"></i>
                        </th>
                        <th class="sortable" data-column="amount">
                            Amount <i class="fas fa-sort sort-icon"></i>
                        </th>
                        <th class="sortable" data-column="status">
                            Status <i class="fas fa-sort sort-icon"></i>
                        </th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for order in orders %}
                    <tr data-transaction="{{ order.orders[0].transaction_type }}" 
                        data-status="{{ order.status }}" 
                        data-exchange="{{ order.condition.exchange }}">
                        <td class="text-center">{{ order.condition.tradingsymbol }}</td>
                        <td class="text-center">{{ order.condition.exchange }}</td>
                        <td class="text-center">{{ order.type }}</td>
                        <td class="text-center">{{ ', '.join(order.condition.trigger_values|map('string')) }}</td>
                        <td class="text-end">{{ "%.2f"|format(order.condition.last_price) }}</td>
                        <td class="text-center">
                            <span class="badge bg-{{ 'success' if order.orders[0].transaction_type == 'BUY' else 'danger' }}">
                                {{ order.orders[0].transaction_type }}
                            </span>
                        </td>
                        <td class="text-end">{{ order.orders[0].quantity }}</td>
                        <td class="text-end amount-cell" data-amount="{{ (order.condition.last_price * order.orders[0].quantity)|round(2) }}">
                            ₹{{ (order.condition.last_price * order.orders[0].quantity)|currency }}
                        </td>
                        <td class="text-center">
                            <span class="badge bg-{{ {
                                'active': 'primary',
                                'triggered': 'success',
                                'cancelled': 'warning',
                                'rejected': 'danger',
                                'deleted': 'secondary'
                            }[order.status] }}">
                                {{ order.status }}
                            </span>
                        </td>
                        <td class="text-center">
                            <div class="btn-group">
                                <a href="{{ url_for('main.order_detail', trigger_id=order.id) }}" 
                                   class="btn btn-sm btn-info" title="View">
                                    <i class="fas fa-eye"></i>
                                </a>
                                <a href="{{ url_for('main.edit_order', trigger_id=order.id) }}" 
                                   class="btn btn-sm btn-warning" title="Edit">
                                    <i class="fas fa-edit"></i>
                                </a>
                                <button onclick="deleteOrder({{ order.id }})" 
                                        class="btn btn-sm btn-danger" title="Delete">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Create Order Modal -->
<div class="modal fade" id="createOrderModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Create New GTT Order</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="createOrderForm">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Trading Symbol</label>
                                <input type="text" class="form-control" name="tradingsymbol" required>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Exchange</label>
                                <select class="form-select" name="exchange" required>
                                    <option value="NSE">NSE</option>
                                    <option value="BSE">BSE</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Trigger Type</label>
                                <select class="form-select" name="trigger_type" required>
                                    <option value="single">Single</option>
                                    <option value="two-leg">Two-Leg</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Trigger Values</label>
                                <input type="text" class="form-control" name="trigger_values" id="triggerValuesInput" required>
                                <small class="form-text text-muted" style="font-size: 0.85em;">Single: one value. Two-leg: comma separated. Used for price calculation.</small>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Last Price</label>
                                <input type="number" step="0.01" class="form-control" name="last_price" id="lastPriceInput" required>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Amount to Invest</label>
                                <input type="number" step="0.01" class="form-control" name="amount_to_invest" id="amountToInvestInput" placeholder="Amount">
                                <small class="form-text text-muted" style="font-size: 0.85em;">Enter amount or quantity. Both fields auto-update using trigger value.</small>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Transaction Type</label>
                                <select class="form-select" name="transaction_type" required>
                                    <option value="BUY">BUY</option>
                                    <option value="SELL">SELL</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Quantity</label>
                                <input type="number" class="form-control" name="quantity" id="quantityInput" required>
                                <small class="form-text text-muted" style="font-size: 0.85em;">Amount and quantity are linked.</small>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="createOrder()">Create Order</button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
// Inline delete function to ensure it's always available
function deleteOrder(orderId) {
    console.log('[DEBUG] deleteOrder called with orderId:', orderId);
    if (confirm('Are you sure you want to delete this order?')) {
        console.log('[DEBUG] User confirmed deletion of order:', orderId);
        fetch('/api/gtt/order/' + orderId, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json'
            }
        })
        .then(function(response) {
            console.log('[DEBUG] Delete response status:', response.status);
            if (!response.ok) {
                throw new Error('HTTP ' + response.status + ': ' + response.statusText);
            }
            return response.json();
        })
        .then(function(data) {
            console.log('[DEBUG] Delete response data:', data);
            if (data.error) {
                console.error('[ERROR] API returned error:', data.error);
                alert('Error: ' + data.error);
            } else {
                console.log('[SUCCESS] Order ' + orderId + ' deleted successfully');
                alert('Order deleted successfully!');
                location.reload();
            }
        })
        .catch(function(error) {
            console.error('[ERROR] Delete Order Error:', error);
            alert('Error deleting order: ' + error.message);
        });
    } else {
        console.log('[DEBUG] User cancelled deletion of order:', orderId);
    }
}

// Test that inline script loaded
console.log('[DEBUG] Inline deleteOrder function loaded');
</script>
<script src="{{ url_for('static', filename='js/dashboard.js') }}"></script>
{% endblock %}

{% include 'multi_gtt_modal.html' %}
