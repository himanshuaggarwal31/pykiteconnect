{% extends 'base.html' %}

{% block title %}Custom GTT Orders{% endblock %}

{% block styles %}
{{ super() }}
<link rel="stylesheet" href="{{ url_for('static', filename='css/custom-gtt.css') }}">
{% endblock %}

{% block content %}
<div class="content-wrapper">
    <!-- Main header with actions -->
    <div class="page-header">
        <div>
            <h2>
                <i class="fas fa-layer-group"></i> Custom GTT Orders
            </h2>
            <p class="lead text-muted">Create and manage multiple GTT orders before placing them on Kite</p>
        </div>
        <div class="btn-toolbar">
            <!-- Primary Actions -->
            <div class="btn-group me-2">
                <button type="button" class="btn btn-primary" id="addNewOrderBtn">
                    <i class="fas fa-plus me-1"></i>Add New Order
                </button>
                <button type="button" class="btn btn-success" id="placeAllOrdersBtn">
                    <i class="fas fa-rocket me-1"></i>Place Selected Orders
                </button>
                <button type="button" class="btn btn-danger" id="deleteSelectedOrdersBtn">
                    <i class="fas fa-trash me-1"></i>Delete Selected Orders
                </button>
            </div>
            
            <!-- Admin/Debug Tools Dropdown -->
            <div class="btn-group">
                <button type="button" class="btn btn-outline-secondary dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false">
                    <i class="fas fa-cog me-1"></i>Tools
                </button>
                <ul class="dropdown-menu">
                    <li><h6 class="dropdown-header">Testing Tools</h6></li>
                    <li><a class="dropdown-item" href="#" onclick="testModal()">
                        <i class="fas fa-bug me-2"></i>Test Modal
                    </a></li>
                    <li><a class="dropdown-item" href="#" onclick="testApiEndpoints()">
                        <i class="fas fa-plug me-2"></i>Test API
                    </a></li>
                    <li><hr class="dropdown-divider"></li>
                    <li><h6 class="dropdown-header">Diagnostics</h6></li>
                    <li><a class="dropdown-item" href="#" onclick="performTableDebug()">
                        <i class="fas fa-table me-2"></i>Debug Table
                    </a></li>
                    <li><a class="dropdown-item" href="#" onclick="performDiagnostics()">
                        <i class="fas fa-stethoscope me-2"></i>Run Diagnostics
                    </a></li>
                    <li><a class="dropdown-item" href="#" onclick="clearDebugMessages()">
                        <i class="fas fa-broom me-2"></i>Clear Debug
                    </a></li>
                    <li><hr class="dropdown-divider"></li>
                    <li><h6 class="dropdown-header">Database</h6></li>
                    <li><a class="dropdown-item" href="#" onclick="fixDatabase()">
                        <i class="fas fa-database me-2"></i>Fix Database
                    </a></li>
                </ul>
            </div>
        </div>
    </div>

    <!-- Controls bar for filters and search -->
    <div class="controls-bar">
        <div class="control-group">
            <!-- Search -->
            <div class="input-group input-group-sm search-input-group">
                <span class="input-group-text">
                    <i class="fas fa-search"></i>
                </span>
                <input type="text" class="form-control" id="searchInput" placeholder="Search symbol...">
            </div>
            
            <!-- Advanced Search -->
            <div class="input-group input-group-sm search-input-group">
                <span class="input-group-text">
                    <i class="fas fa-filter"></i>
                </span>
                <input type="text" class="form-control" id="advancedSearchInput" 
                       placeholder="e.g. QTY > 10 AND PCT_CHG > 5">
                <button class="btn btn-outline-secondary dropdown-toggle" type="button" 
                        data-bs-toggle="dropdown" aria-expanded="false" id="savedFiltersBtn">
                    <i class="fas fa-bookmark"></i>
                </button>
                <ul class="dropdown-menu" id="savedFiltersMenu">
                    <li><h6 class="dropdown-header">Saved Filters</h6></li>
                    <li><hr class="dropdown-divider"></li>
                    <li><a class="dropdown-item" href="#" id="saveCurrentFilter">
                        <i class="fas fa-save me-2"></i>Save Current Filter
                    </a></li>
                    <li><a class="dropdown-item" href="#" id="manageFilters">
                        <i class="fas fa-cog me-2"></i>Manage Filters
                    </a></li>
                    <li><hr class="dropdown-divider"></li>
                    <li id="noSavedFilters"><span class="dropdown-item-text text-muted">No saved filters</span></li>
                </ul>
                <button class="btn btn-outline-secondary" type="button" id="advancedSearchHelp" 
                        data-bs-toggle="tooltip" data-bs-placement="top" 
                        title="Supported: SYMBOL, QTY, AMOUNT, TRIGGER_PRICE, LAST_PRICE, RANK, PCT_CHG. Operators: >, <, >=, <=, =, !=. Logic: AND, OR">
                    <i class="fas fa-question-circle"></i>
                </button>
            </div>
            
            <!-- Order Type filter -->
            <select class="form-select form-select-sm compact-select" id="orderTypeFilter">
                <option value="">All Order Types</option>
                <option value="BUY">Buy Orders</option>
                <option value="SELL">Sell Orders</option>
            </select>
            
            <!-- Kite Status filter -->
            <select class="form-select form-select-sm compact-select" id="kiteStatusFilter">
                <option value="">All Kite Status</option>
                <option value="not_placed">Not Placed</option>
                <option value="placed">Placed</option>
                <option value="failed">Failed</option>
            </select>
            
            <!-- Records per page -->
            <select class="form-select form-select-sm compact-select" id="recordsPerPage">
                <option value="10">10</option>
                <option value="25">25</option>
                <option value="50">50</option>
                <option value="100">100</option>
                <option value="-1" selected>All</option>
            </select>
            
            <!-- Reset filters button -->
            <button class="btn btn-outline-danger btn-sm" type="button" id="resetFiltersBtn" 
                    title="Clear all filters and reset to default view">
                <i class="fas fa-undo"></i> Reset
            </button>
        </div>
    </div>

    {% if error %}
    <div class="alert alert-warning py-2" style="font-size: 0.875rem;">
        <i class="fas fa-exclamation-triangle me-2"></i>
        {{ error }}
    </div>
    {% endif %}

    <!-- Main table -->
    <div class="table-wrapper">
        <div class="d-flex justify-content-between px-3 py-2 border-bottom bg-light">
            <div class="custom-control custom-checkbox">
                <input type="checkbox" class="custom-control-input" id="selectAllOrdersMain">
                <label class="custom-control-label" for="selectAllOrdersMain">Select All</label>
                <span class="ms-2 badge bg-primary" id="selectedCount">0</span> selected
            </div>
            <div class="text-muted" style="font-size: 0.875rem;">
                <strong class="me-3">Total Selected Amount: ₹<span id="totalAmount">0.00</span></strong>
                <strong class="me-3">Total Amount: ₹<span id="totalAllAmount">0.00</span></strong>
                <small class="ms-3">Showing <span id="currentRecords">0</span> of <span id="totalRecords">0</span> orders</small>
            </div>
        </div>
        <div class="table-responsive">
            <table class="table table-hover table-compact" id="customGttTable">
                <thead>
                    <tr>
                        <th><input type="checkbox" id="selectAllOrders"></th>
                        <th class="sortable" data-column="symbol">
                            Symbol <i class="fas fa-sort sort-icon"></i>
                        </th>
                        <th class="sortable" data-column="company_name">
                            Company <i class="fas fa-sort sort-icon"></i>
                        </th>
                        <th class="sortable" data-column="exchange">
                            Exch <i class="fas fa-sort sort-icon"></i>
                        </th>
                        <th class="sortable" data-column="order_type">
                            Type <i class="fas fa-sort sort-icon"></i>
                        </th>
                        <th class="sortable" data-column="trigger_price">
                            Trigger <i class="fas fa-sort sort-icon"></i>
                        </th>
                        <th class="sortable" data-column="last_price">
                            Last Price <i class="fas fa-sort sort-icon"></i>
                        </th>
                        <th class="sortable percentage-change-column" data-column="percentage_change">
                            % Chg <i class="fas fa-sort sort-icon"></i>
                        </th>
                        <th class="sortable" data-column="quantity">
                            Qty <i class="fas fa-sort sort-icon"></i>
                        </th>
                        <th class="sortable" data-column="amount">
                            Amount <i class="fas fa-sort sort-icon"></i>
                        </th>
                        <th class="sortable" data-column="nifty_rank">
                            Rank <i class="fas fa-sort sort-icon"></i>
                        </th>
                        <th>Notes</th>
                        <th class="sortable" data-column="placed_on_kite">
                            St <i class="fas fa-sort sort-icon"></i>
                        </th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="customGttTableBody">
                    <!-- Table will be populated by JavaScript -->
                </tbody>
            </table>
        </div>
        
        <!-- Pagination -->
        <div class="d-flex justify-content-between align-items-center px-3 py-2 border-top bg-light">
            <div class="pagination-info">
                Showing page <span id="currentPage">1</span> of <span id="totalPages">1</span>
            </div>
            <div class="pagination-controls">
                <button class="btn btn-sm btn-outline-secondary" id="prevPageBtn">
                    <i class="fas fa-chevron-left"></i> Prev
                </button>
                <button class="btn btn-sm btn-outline-secondary ms-2" id="nextPageBtn">
                    Next <i class="fas fa-chevron-right"></i>
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Order Modal -->
<div class="modal fade" id="orderModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header py-2">
                <h5 class="modal-title" id="orderModalTitle">Add New Order</h5>
                <div class="d-flex gap-2">
                    <button type="button" class="btn btn-primary btn-sm" id="saveOrderBtnTop" onclick="saveOrder()">
                        <i class="fas fa-save me-1"></i>Save
                    </button>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
            </div>
            <div class="modal-body py-3">
                <form id="orderForm">
                    <input type="hidden" id="orderId" name="id">
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-2">
                                <label for="symbol" class="form-label">Trading Symbol</label>
                                <input type="text" class="form-control form-control-sm" id="symbol" name="symbol" required>
                            </div>
                            <div class="mb-2">
                                <label for="companyName" class="form-label">Company Name</label>
                                <input type="text" class="form-control form-control-sm" id="companyName" name="company_name">
                            </div>
                            
                            <!-- Exchange, Order Type, and Nifty Rank in one row -->
                            <div class="row mb-2">
                                <div class="col-4">
                                    <label for="exchange" class="form-label">Exchange</label>
                                    <select class="form-select form-select-sm" id="exchange" name="exchange" required>
                                        <option value="NSE">NSE</option>
                                        <option value="BSE">BSE</option>
                                    </select>
                                </div>
                                <div class="col-4">
                                    <label for="orderType" class="form-label">Order Type</label>
                                    <select class="form-select form-select-sm" id="orderType" name="order_type" required>
                                        <option value="BUY">BUY</option>
                                        <option value="SELL">SELL</option>
                                    </select>
                                </div>
                                <div class="col-4">
                                    <label for="niftyRank" class="form-label">Nifty Rank</label>
                                    <input type="number" class="form-control form-control-sm" id="niftyRank" name="nifty_rank" min="0" placeholder="Optional">
                                </div>
                            </div>
                            
                            <div class="mb-2">
                                <label for="triggerType" class="form-label">Trigger Type</label>
                                <select class="form-select form-select-sm" id="triggerType" name="trigger_type" required>
                                    <option value="single">Single (One Price Point)</option>
                                    <option value="two-leg">Two-Leg (Target & Stop Loss)</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <!-- Single trigger fields -->
                            <div id="singleTriggerFields">
                                <div class="mb-2">
                                    <label for="triggerPrice" class="form-label">Trigger Price</label>
                                    <input type="number" step="0.01" class="form-control form-control-sm" id="triggerPrice" name="trigger_price">
                                    <small class="form-text text-muted">For BUY: Set below market price. For SELL: Set above market price.</small>
                                </div>
                            </div>
                            
                            <!-- Two-leg trigger fields -->
                            <div id="twoLegTriggerFields" style="display:none;">
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-2">
                                            <label for="targetPrice" class="form-label">Target Price</label>
                                            <input type="number" step="0.01" class="form-control form-control-sm" id="targetPrice" name="target_price">
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-2">
                                            <label for="stopLoss" class="form-label">Stop Loss</label>
                                            <input type="number" step="0.01" class="form-control form-control-sm" id="stopLoss" name="stop_loss">
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="row mb-2">
                                <div class="col-8">
                                    <label for="lastPrice" class="form-label">Last Price</label>
                                    <div class="input-group input-group-sm">
                                        <input type="number" step="0.01" class="form-control" id="lastPrice" name="last_price">
                                        <button class="btn btn-outline-secondary" type="button" id="fetchPriceBtn">
                                            <i class="fas fa-sync-alt"></i>
                                        </button>
                                    </div>
                                </div>
                                <div class="col-4">
                                    <label for="quantity" class="form-label">Quantity</label>
                                    <input type="number" class="form-control form-control-sm" id="quantity" name="quantity" required>
                                </div>
                            </div>
                            
                            <div class="mb-2">
                                <label for="orderAmount" class="form-label">Total Amount</label>
                                <div class="input-group input-group-sm">
                                    <span class="input-group-text">₹</span>
                                    <span class="form-control" id="orderAmount">0.00</span>
                                </div>
                                <small class="form-text text-muted">Total value (Price × Quantity)</small>
                            </div>
                        </div>
                    </div>
                    <div class="row mt-2">
                        <div class="col-12">
                            <div class="mb-2">
                                <label for="notes" class="form-label">Notes</label>
                                <textarea class="form-control form-control-sm" id="notes" name="notes" rows="2"></textarea>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer py-2">
                <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary btn-sm" id="saveOrderBtn" onclick="saveOrder()">
                    <i class="fas fa-save me-1"></i>Save Order
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Confirmation Modal -->
<div class="modal fade" id="confirmationModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="confirmationTitle">Confirmation</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="confirmationBody">
                Are you sure you want to perform this action?
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="confirmActionBtn">Confirm</button>
            </div>
        </div>
    </div>
</div>

<!-- Toast for notifications -->
<div class="position-fixed bottom-0 end-0 p-3" style="z-index: 5">
    <div id="notificationToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="toast-header">
            <strong class="me-auto" id="toastTitle">Notification</strong>
            <button type="button" class="btn-close" data-bs-dismiss="toast"></button>
        </div>
        <div class="toast-body" id="toastBody">
            Message here
        </div>
    </div>
</div>

<!-- Debugging container (hidden by default) -->
<div id="debugContainer" style="display:none; position:fixed; top:10px; right:10px; width:300px; z-index:9999;"></div>
{% endblock %}

{% block scripts %}
<!-- No need for super() since we're providing full script block -->
<script src="{{ url_for('static', filename='js/search.js') }}"></script>
<script src="{{ url_for('static', filename='js/shared-controls.js') }}"></script>
<script>
// Simple diagnostic script to verify Bootstrap is working
document.addEventListener('DOMContentLoaded', function() {
    console.log('Diagnostic script loaded');
    console.log('Bootstrap available:', typeof bootstrap !== 'undefined');
    console.log('Modal class available:', typeof bootstrap !== 'undefined' && typeof bootstrap.Modal !== 'undefined');
    
    // Add direct click handler to verify button is working
    const addBtn = document.getElementById('addNewOrderBtn');
    if (addBtn) {
        console.log('Found Add New Order button, adding direct handler');
        addBtn.addEventListener('click', function(event) {
            console.log('Add New Order button clicked (direct handler)');
            
            const modalEl = document.getElementById('orderModal');
            if (modalEl && typeof bootstrap !== 'undefined' && typeof bootstrap.Modal !== 'undefined') {
                console.log('Showing modal directly from diagnostic script');
                const modal = new bootstrap.Modal(modalEl);
                modal.show();
            } else {
                console.error('Cannot show modal - missing elements or Bootstrap');
                alert('Cannot show modal. Check console for details.');
            }
        });
    } else {
        console.error('Add New Order button not found in diagnostic script');
    }
});

// Test modal function for the test button
function testModal() {
    console.log('Test modal button clicked');
    
    // Verify Bootstrap is loaded
    if (typeof bootstrap === 'undefined') {
        alert('Bootstrap is not loaded!');
        return;
    }
    
    // Find the modal element
    const modalEl = document.getElementById('orderModal');
    if (!modalEl) {
        alert('Modal element not found!');
        return;
    }
    
    try {
        // Try to show the modal
        const modal = new bootstrap.Modal(modalEl);
        modal.show();
        console.log('Modal should be showing now');
        
        // Add direct save button handler
        document.getElementById('saveOrderBtn').addEventListener('click', function() {
            console.log('Save button clicked (direct handler)');
            
            // Get form data
            const form = document.getElementById('orderForm');
            if (!form) {
                alert('Form not found!');
                return;
            }
            
            const formData = new FormData(form);
            const data = {};
            formData.forEach((value, key) => {
                data[key] = value;
            });
            
            console.log('Form data:', data);
            
            // Test API call
            document.getElementById('saveOrderBtn').innerHTML = 'Saving...';
            
            // First try the debug endpoint to check if database connection works
            console.log('Testing debug endpoint first...');
            fetch('/api/test-save', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    symbol: data.symbol,
                    quantity: data.quantity || 1,
                    trigger_price: data.trigger_price || 100
                })
            })
            .then(response => response.json())
            .then(debugResult => {
                console.log('Debug endpoint result:', debugResult);
                console.log('Now trying the actual endpoint...');
                
                // Then try the actual endpoint
                return fetch('/api/custom-gtt/save-order', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });
            })
            .then(response => {
                if (!response.ok) {
                    return response.json().then(errData => {
                        throw new Error(`Server error: ${errData.error || response.statusText}`);
                    });
                }
                return response.json();
            })
            .then(result => {
                document.getElementById('saveOrderBtn').innerHTML = 'Save Order';
                console.log('API response:', result);
                alert('Order saved: ' + JSON.stringify(result));
                if (result.success) {
                    modal.hide();
                }
            })
            .catch(error => {
                document.getElementById('saveOrderBtn').innerHTML = 'Save Order';
                console.error('API error:', error);
                alert('Error saving order: ' + error.message);
            });
        });
    } catch (err) {
        console.error('Error showing modal:', err);
        alert('Error showing modal: ' + err.message);
    }
}

// Direct save function to bypass the complex logic in custom-gtt.js
function saveOrderDirect() {
    console.log('Direct save function called');
    
    // Run price validation first
    if (typeof validatePrices === 'function') {
        const isValid = validatePrices();
        if (!isValid) {
            showToast('Please fix the price validation errors before saving', 'error');
            return;
        }
    }
    
    // Get form data
    const form = document.getElementById('orderForm');
    if (!form) {
        alert('Form not found!');
        return;
    }
    
    const formData = new FormData(form);
    const data = {};
    formData.forEach((value, key) => {
        // Only add non-empty values, making fields like company_name truly optional
        if (value !== null && value !== '') {
            data[key] = value;
        }
    });
    
    console.log('Form data:', data);
    
    // Show loading state
    const saveBtn = document.getElementById('saveOrderBtn');
    saveBtn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Saving...';
    saveBtn.disabled = true;
    
    // Calculate the amount for logging purposes
    const quantity = parseInt(data.quantity) || 0;
    const price = parseFloat(data.last_price) || parseFloat(data.trigger_price) || 0;
    const amount = quantity * price;
    console.log(`Order amount: ${amount} (${quantity} × ${price})`);
    
    // Try direct API call to debug endpoint
    fetch('/api/test-save', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            symbol: data.symbol,
            company_name: data.company_name, // Allow it to be undefined/optional
            nifty_rank: data.nifty_rank || 0,
            quantity: data.quantity || 1,
            trigger_price: data.trigger_price || 100,
            target_price: data.target_price || null,
            stop_loss: data.stop_loss || null,
            order_type: data.order_type || 'BUY',
            trigger_type: data.trigger_type || 'single',
            exchange: data.exchange || 'NSE',
            last_price: data.last_price || 105,
            notes: data.notes || ''
        })
    })
    .then(response => {
        console.log('Debug endpoint response status:', response.status);
        // Check if response is OK (200-299)
        if (!response.ok) {
            if (response.status === 404) {
                throw new Error('API endpoint not found (404). Check route configuration.');
            }
            if (response.status === 500) {
                throw new Error('Server error (500). Check server logs for details.');
            }
            throw new Error(`Server responded with status: ${response.status}`);
        }
        
        // Check content type to ensure we're getting JSON
        let contentType = null;
        try {
            if (response.headers && typeof response.headers.get === 'function') {
                contentType = response.headers.get('content-type');
            }
        } catch (headerError) {
            console.warn('Could not read response headers:', headerError);
        }
        
        if (contentType && !contentType.includes('application/json')) {
            console.error('Response is not JSON:', contentType);
            throw new Error('Received non-JSON response from server');
        }
        
        return response.json();
    })
    .then(debugResult => {
        console.log('Debug save result:', debugResult);
        
        if (debugResult.success) {
            console.log('Order saved through debug endpoint! ID: ' + debugResult.order_id);
            
            // Now try with the actual endpoint
            return fetch('/api/custom-gtt/save-order', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(data)
            })
            .then(response => {
                console.log('Save endpoint response status:', response.status);
                // Check if response is OK (200-299)
                if (!response.ok) {
                    if (response.status === 404) {
                        throw new Error('API endpoint not found (404). Check route configuration.');
                    }
                    if (response.status === 500) {
                        throw new Error('Server error (500). Check server logs for details.');
                    }
                    throw new Error(`Server responded with status: ${response.status}`);
                }
                
                // Check content type to ensure we're getting JSON
                let contentType = null;
                try {
                    if (response.headers && typeof response.headers.get === 'function') {
                        contentType = response.headers.get('content-type');
                    }
                } catch (headerError) {
                    console.warn('Could not read response headers:', headerError);
                }
                
                if (contentType && !contentType.includes('application/json')) {
                    console.error('Response is not JSON:', contentType);
                    throw new Error('Received non-JSON response from server');
                }
                
                return response.json();
            });
        } else {
            if (debugResult.error && debugResult.error.includes("TRIGGER_VALUES")) {
                alert('Database error with TRIGGER_VALUES column. Please click "Fix DB" button and try again.');
                const fixBtn = document.getElementById('fixDatabaseBtn');
                if (fixBtn) {
                    fixBtn.classList.add('btn-danger');
                    fixBtn.classList.add('animate__animated');
                    fixBtn.classList.add('animate__pulse');
                    setTimeout(() => {
                        fixBtn.classList.remove('btn-danger');
                        fixBtn.classList.remove('animate__animated');
                        fixBtn.classList.remove('animate__pulse');
                    }, 3000);
                }
            }
            throw new Error('Debug save failed: ' + debugResult.error);
        }
    })
    .then(response => {
        console.log('Save order response status:', response.status);
        
        // Safely log response headers
        try {
            if (response.headers && typeof response.headers.entries === 'function') {
                console.log('Save order response headers:', [...response.headers.entries()]);
            } else {
                console.log('Save order response headers: Not available');
            }
        } catch (e) {
            console.log('Could not log response headers:', e.message);
        }
        
        // Check response headers to make sure we're getting JSON
        const contentType = response.headers.get('content-type');
        if (!contentType || !contentType.includes('application/json')) {
            console.error('Response is not JSON:', contentType);
            throw new Error('Server did not return JSON response');
        }
        
        return response.json();
    })
    .then(result => {
        saveBtn.innerHTML = 'Save Order';
        saveBtn.disabled = false;
        
        console.log('API response:', result);
        if (result.success) {
            // Show notification toast instead of alert
            showToast('Order saved successfully!', 'success');
            
            // Close the modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('orderModal'));
            if (modal) modal.hide();
            
            // If we have the order data, we can update the table immediately without a page refresh
            if (result.order) {
                console.log('Adding new order to table:', result.order);
                
                // Refresh the table data
                fetch('/api/custom-gtt/orders')
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`Error fetching orders: ${response.status}`);
                        }
                        return response.json();
                    })
                    .then(data => {
                        if (data.success !== false) {
                            updateOrdersTable(data);
                        }
                    })
                    .catch(err => {
                        console.error('Error refreshing table data:', err);
                        showToast('Failed to refresh order data: ' + err.message, 'warning');
                    });
            } else {
                // Fallback to page reload if order data not available
                setTimeout(() => {
                    location.reload();
                }, 1000);
            }
        } else {
            showToast('Error: ' + (result.error || 'Unknown error'), 'error');
        }
    })
    .catch(error => {
        console.error('Error saving order:', error);
        saveBtn.innerHTML = 'Save Order';
        saveBtn.disabled = false;
        
        // Show a more user-friendly error with details in console
        showToast('Error saving order: ' + error.message, 'error');
        
        // Add a debug button to help investigate
        const debugInfo = document.createElement('div');
        debugInfo.className = 'mt-3 text-danger';
        debugInfo.innerHTML = `
            <p><strong>Debug Info:</strong> ${error.message}</p>
            <button class="btn btn-sm btn-outline-secondary" onclick="fixDatabase()">
                <i class="fas fa-wrench me-1"></i>Fix Database
            </button>
        `;
        
        // Add to modal body
        const modalBody = document.querySelector('#orderModal .modal-body');
        if (modalBody) {
            // Remove any existing debug info
            const existingDebug = modalBody.querySelector('.text-danger');
            if (existingDebug) existingDebug.remove();
            
            modalBody.appendChild(debugInfo);
        }
    });
}

/**
 * Show a toast notification
 * @param {string} message - The message to display
 * @param {string} type - The type of notification (success, error, warning, info)
 */
function showToast(message, type = 'info') {
    const toast = document.getElementById('notificationToast');
    const toastTitle = document.getElementById('toastTitle');
    const toastBody = document.getElementById('toastBody');
    
    // Set the title based on type
    let title = 'Notification';
    let bgClass = 'bg-info';
    
    switch (type) {
        case 'success':
            title = 'Success';
            bgClass = 'bg-success';
            break;
        case 'error':
            title = 'Error';
            bgClass = 'bg-danger';
            break;
        case 'warning':
            title = 'Warning';
            bgClass = 'bg-warning';
            break;
    }
    
    // Set content
    toastTitle.textContent = title;
    toastBody.textContent = message;
    
    // Remove any existing background classes
    toast.classList.remove('bg-success', 'bg-danger', 'bg-warning', 'bg-info');
    
    // Add the appropriate class
    toast.classList.add(bgClass);
    
    // Show the toast
    const bsToast = new bootstrap.Toast(toast);
    bsToast.show();
}

// Function to diagnose and fix database issues
function fixDatabase() {
    console.log('Checking and fixing database structure...');
    
    const fixBtn = document.getElementById('fixDatabaseBtn');
    const originalText = fixBtn.innerHTML;
    fixBtn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Checking...';
    fixBtn.disabled = true;
    
    // First check the table structure
    fetch('/api/table-info')
        .then(response => response.json())
        .then(info => {
            console.log('Table info:', info);
            
            // Check if trigger_values column exists
            let triggerValuesExists = false;
            if (info.exists && info.columns) {
                triggerValuesExists = info.columns.some(col => 
                    col.name === 'TRIGGER_VALUES' || col.name === 'trigger_values');
            }
            
            if (!triggerValuesExists) {
                console.log('TRIGGER_VALUES column is missing, attempting to fix...');
                fixBtn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Fixing...';
                
                // Try to fix the table structure
                return fetch('/api/fix-table', {
                    method: 'POST'
                });
            } else {
                return new Response(JSON.stringify({
                    success: true,
                    actions: ['All columns exist, no fixes needed']
                }), { 
                    headers: { 'Content-Type': 'application/json' }
                });
            }
        })
        .then(response => response.json())
        .then(result => {
            console.log('Fix result:', result);
            fixBtn.innerHTML = originalText;
            fixBtn.disabled = false;
            
            if (result.success) {
                alert('Database checked and fixed if needed:\n\n' + result.actions.join('\n'));
            } else {
                alert('Error fixing database: ' + (result.error || 'Unknown error'));
            }
        })
        .catch(error => {
            console.error('Error diagnosing/fixing database:', error);
            fixBtn.innerHTML = originalText;
            fixBtn.disabled = false;
            alert('Error checking/fixing database: ' + error.message);
        });
}

// Function to test API endpoints
function testApiEndpoints() {
    console.log('Testing API endpoints...');
    
    const testBtn = document.getElementById('testApiBtn');
    if (testBtn) {
        const originalText = testBtn.innerHTML;
        testBtn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Testing...';
        testBtn.disabled = true;
        
        // Test the debug API endpoint
        fetch('/api/test-route')
            .then(response => {
                console.log('Test route response status:', response.status);
                const contentType = response.headers.get('content-type');
                console.log('Test route content type:', contentType);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                if (!contentType || !contentType.includes('application/json')) {
                    throw new Error('Response is not JSON');
                }
                
                return response.json();
            })
            .then(data => {
                console.log('API test result:', data);
                testBtn.innerHTML = originalText;
                testBtn.disabled = false;
                
                // Display routes in an alert for diagnostics
                let routeInfo = 'Available API routes:\n\n';
                if (data.api_routes && data.api_routes.length > 0) {
                    data.api_routes.forEach(route => {
                        routeInfo += `${route.rule} (${route.methods.join(', ')})\n`;
                    });
                } else {
                    routeInfo += 'No API routes found!';
                }
                
                showToast('API endpoints tested successfully', 'success');
                alert(routeInfo);
            })
            .catch(error => {
                console.error('API test error:', error);
                testBtn.innerHTML = originalText;
                testBtn.disabled = false;
                showToast(`API test failed: ${error.message}`, 'error');
            });
    }
}

// Comprehensive debugging functions
function performDiagnostics() {
    console.log('=== DIAGNOSTIC STARTED ===');
    showDebugMessage('🔍 Starting comprehensive diagnostics...', 'info');
    
    // Run server-side diagnostics
    fetch('/api/diagnostics')
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            return response.json();
        })
        .then(diagnostics => {
            console.log('Server diagnostics completed:', diagnostics);
            
            // Display results
            diagnostics.tests.forEach(test => {
                const icon = test.status === 'pass' ? '✅' : test.status === 'fail' ? '❌' : '⚠️';
                showDebugMessage(`${icon} ${test.name}: ${test.message}`, test.status === 'pass' ? 'success' : test.status === 'fail' ? 'error' : 'warning');
            });
            
            // Show summary
            const summary = diagnostics.summary;
            showDebugMessage(`📊 Summary: ${summary.passed}/${summary.total_tests} tests passed, ${summary.failed} failed, ${summary.warnings} warnings`, 'info');
            
            // Also run browser-side tests
            performBrowserTests();
        })
        .catch(error => {
            console.error('❌ Server diagnostics failed:', error);
            showDebugMessage('❌ Server diagnostics failed: ' + error.message, 'error');
            
            // Still run browser tests
            performBrowserTests();
        });
}

function performBrowserTests() {
    // Test 4: Browser environment
    console.log('Running browser environment checks...');
    const checks = [
        { name: 'Fetch API support', test: () => 'fetch' in window },
        { name: 'Promise support', test: () => 'Promise' in window },
        { name: 'DOM ready', test: () => document.readyState === 'complete' },
        { name: 'Bootstrap available', test: () => typeof bootstrap !== 'undefined' },
        { name: 'jQuery available', test: () => typeof $ !== 'undefined' },
        { name: 'Console available', test: () => typeof console !== 'undefined' }
    ];
    
    checks.forEach(check => {
        const result = check.test();
        const icon = result ? '✅' : '❌';
        console.log(`${icon} ${check.name}: ${result}`);
        showDebugMessage(`${icon} Browser ${check.name}: ${result}`, result ? 'success' : 'error');
    });
    
    // Test API endpoints from browser
    testBrowserApiAccess();
}

function testBrowserApiAccess() {
    const endpoints = [
        { url: '/api/test', name: 'Basic API' },
        { url: '/api/custom-gtt/orders', name: 'Custom GTT Orders' },
        { url: '/api/table-info', name: 'Table Info' }
    ];
    
    endpoints.forEach(endpoint => {
        fetch(endpoint.url)
            .then(response => {
                const icon = response.ok ? '✅' : '❌';
                showDebugMessage(`${icon} ${endpoint.name} (${endpoint.url}): HTTP ${response.status}`, response.ok ? 'success' : 'error');
                return response.json();
            })
            .then(data => {
                console.log(`${endpoint.name} response:`, data);
            })
            .catch(error => {
                showDebugMessage(`❌ ${endpoint.name} (${endpoint.url}): ${error.message}`, 'error');
            });
    });
}

function showDebugMessage(message, type = 'info') {
    const debugContainer = document.getElementById('debugContainer') || createDebugContainer();
    const messageDiv = document.createElement('div');
    messageDiv.className = `alert alert-${type === 'success' ? 'success' : type === 'error' ? 'danger' : 'warning'} alert-sm mb-1`;
    messageDiv.textContent = message;
    debugContainer.appendChild(messageDiv);
    
    // Auto-remove after 10 seconds
    setTimeout(() => {
        if (messageDiv.parentNode) {
            messageDiv.remove();
        }
    }, 10000);
}

function createDebugContainer() {
    const container = document.createElement('div');
    container.id = 'debugContainer';
    container.style.position = 'fixed';
    container.style.top = '10px';
    container.style.right = '10px';
    container.style.width = '400px';
    container.style.zIndex = '9999';
    container.style.maxHeight = '300px';
    container.style.overflowY = 'auto';
    document.body.appendChild(container);
    return container;
}

function clearDebugMessages() {
    const debugContainer = document.getElementById('debugContainer');
    if (debugContainer) {
        debugContainer.innerHTML = '';
    }
}

/**
 * Auto-populate company name and last price based on symbol
 */
function setupSymbolAutopopulation() {
    const symbolInput = document.getElementById('symbol');
    const companyNameInput = document.getElementById('companyName');
    const lastPriceInput = document.getElementById('lastPrice');
    const exchangeSelect = document.getElementById('exchange');
    const fetchPriceBtn = document.getElementById('fetchPriceBtn');

    // Symbol lookup table (you can provide your vlookup table here)
    const symbolToCompanyMap = {
        'RELIANCE': 'Reliance Industries Limited',
        'TCS': 'Tata Consultancy Services Limited',
        'HDFCBANK': 'HDFC Bank Limited',
        'INFY': 'Infosys Limited',
        'HINDUNILVR': 'Hindustan Unilever Limited',
        'ICICIBANK': 'ICICI Bank Limited',
        'KOTAKBANK': 'Kotak Mahindra Bank Limited',
        'BAJFINANCE': 'Bajaj Finance Limited',
        'ITC': 'ITC Limited',
        'SBIN': 'State Bank of India',
        // Add more mappings as needed
    };

    // Auto-populate company name when symbol changes
    symbolInput.addEventListener('blur', function() {
        const symbol = this.value.trim().toUpperCase();
        if (symbol) {
            // Use the comprehensive symbol info API that combines both vlookup tables
            fetch(`/api/custom-gtt/get-symbol-info/${symbol}?exchange=${exchangeSelect.value}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        let messages = [];
                        
                        // Auto-populate company name if found
                        if (data.company_name) {
                            companyNameInput.value = data.company_name;
                            messages.push(`Company: ${data.company_name}`);
                        }
                        
                        // Auto-populate last price if found from database
                        if (data.latest_price) {
                            lastPriceInput.value = data.latest_price.toFixed(2);
                            messages.push(`DB price: ₹${data.latest_price.toFixed(2)} (${data.stock_date || 'recent'})`);
                        }
                        
                        // Auto-populate Nifty Rank if available
                        const niftyRankInput = document.getElementById('niftyRank');
                        if (niftyRankInput && data.nifty_rank) {
                            niftyRankInput.value = data.nifty_rank;
                            messages.push(`Nifty rank: ${data.nifty_rank}`);
                        }
                        
                        // Show success message with all populated data
                        if (messages.length > 0) {
                            showToast(`Symbol info loaded: ${messages.join(', ')}`, 'success');
                            
                            // Show additional info if available
                            if (data.mcap_lakhs || data.him_rating) {
                                showSymbolInfo(data);
                            }
                            
                            // Trigger validation after data is populated
                            setTimeout(() => {
                                validatePrices();
                            }, 100);
                        }
                        
                        // If no price found in database, try live fetch
                        if (!data.latest_price) {
                            fetchLatestPrice();
                        }
                    } else {
                        // Clear fields if not found
                        companyNameInput.value = '';
                        const niftyRankInput = document.getElementById('niftyRank');
                        if (niftyRankInput) {
                            niftyRankInput.value = '';
                        }
                        clearSymbolInfo();
                        
                        // Try live price fetch as fallback
                        fetchLatestPrice();
                    }
                })
                .catch(error => {
                    console.log('Symbol info lookup failed:', error);
                    clearSymbolInfo();
                    
                    // Try live price fetch as fallback
                    fetchLatestPrice();
                });
        }
    });

    // Fetch price button click
    fetchPriceBtn.addEventListener('click', fetchLatestPrice);

    function fetchLatestPrice() {
        const symbol = symbolInput.value.trim().toUpperCase();
        const exchange = exchangeSelect.value;
        
        if (!symbol) {
            showToast('Please enter a trading symbol', 'warning');
            return;
        }

        // Show loading
        fetchPriceBtn.innerHTML = '<span class="spinner-border spinner-border-sm"></span>';
        fetchPriceBtn.disabled = true;

        fetch(`/api/custom-gtt/get-latest-price/${symbol}?exchange=${exchange}`)
            .then(response => response.json())
            .then(data => {
                // Reset button
                fetchPriceBtn.innerHTML = '<i class="fas fa-sync-alt"></i> Fetch';
                fetchPriceBtn.disabled = false;

                if (data.success) {
                    lastPriceInput.value = data.latest_price.toFixed(2);
                    showToast(`Latest price fetched: ₹${data.latest_price.toFixed(2)}`, 'success');
                    
                    // Trigger validation after price is fetched
                    validatePrices();
                } else {
                    showToast(data.error || 'Failed to fetch latest price', 'error');
                }
            })
            .catch(error => {
                // Reset button
                fetchPriceBtn.innerHTML = '<i class="fas fa-sync-alt"></i> Fetch';
                fetchPriceBtn.disabled = false;
                showToast('Error fetching latest price', 'error');
                console.error('Error:', error);
            });
    }
}

/**
 * Setup price validation
 */
function setupPriceValidation() {
    const lastPriceInput = document.getElementById('lastPrice');
    const triggerPriceInput = document.getElementById('triggerPrice');
    const targetPriceInput = document.getElementById('targetPrice');
    const stopLossInput = document.getElementById('stopLoss');
    const orderTypeSelect = document.getElementById('orderType');

    // Add validation listeners
    [lastPriceInput, triggerPriceInput, targetPriceInput, stopLossInput, orderTypeSelect].forEach(element => {
        if (element) {
            element.addEventListener('input', validatePrices);
            element.addEventListener('change', validatePrices);
        }
    });

    function validatePrices() {
        const lastPrice = parseFloat(lastPriceInput.value) || 0;
        const triggerPrice = parseFloat(triggerPriceInput.value) || 0;
        const targetPrice = parseFloat(targetPriceInput.value) || 0;
        const stopLoss = parseFloat(stopLossInput.value) || 0;
        const orderType = orderTypeSelect.value;

        // Clear previous validation states
        clearValidationStates();

        if (lastPrice === 0) return; // No validation if last price not set

        // Validation rules
        let isValid = true;
        const errors = [];

        if (triggerPrice > 0) {
            if (orderType === 'BUY') {
                // For BUY orders: trigger price should be less than or equal to last price
                if (triggerPrice > lastPrice) {
                    setFieldError(triggerPriceInput, `Trigger price (₹${triggerPrice}) should be ≤ last price (₹${lastPrice}) for BUY orders`);
                    errors.push('Invalid trigger price for BUY order');
                    isValid = false;
                } else {
                    setFieldSuccess(triggerPriceInput);
                }
            } else if (orderType === 'SELL') {
                // For SELL orders: trigger price should be greater than or equal to last price
                if (triggerPrice < lastPrice) {
                    setFieldError(triggerPriceInput, `Trigger price (₹${triggerPrice}) should be ≥ last price (₹${lastPrice}) for SELL orders`);
                    errors.push('Invalid trigger price for SELL order');
                    isValid = false;
                } else {
                    setFieldSuccess(triggerPriceInput);
                }
            }
        }

        if (targetPrice > 0) {
            if (orderType === 'BUY') {
                // For BUY orders: target price should be greater than last price
                if (targetPrice <= lastPrice) {
                    setFieldError(targetPriceInput, `Target price (₹${targetPrice}) should be > last price (₹${lastPrice})`);
                    errors.push('Target price too low');
                    isValid = false;
                } else {
                    setFieldSuccess(targetPriceInput);
                }
            } else if (orderType === 'SELL') {
                // For SELL orders: target price should be greater than last price
                if (targetPrice <= lastPrice) {
                    setFieldError(targetPriceInput, `Target price (₹${targetPrice}) should be > last price (₹${lastPrice})`);
                    errors.push('Target price too low');
                    isValid = false;
                } else {
                    setFieldSuccess(targetPriceInput);
                }
            }
        }

        if (stopLoss > 0) {
            if (orderType === 'BUY') {
                // For BUY orders: stop loss should be less than last price
                if (stopLoss >= lastPrice) {
                    setFieldError(stopLossInput, `Stop loss (₹${stopLoss}) should be < last price (₹${lastPrice})`);
                    errors.push('Stop loss too high');
                    isValid = false;
                } else {
                    setFieldSuccess(stopLossInput);
                }
            } else if (orderType === 'SELL') {
                // For SELL orders: stop loss should be less than last price
                if (stopLoss >= lastPrice) {
                    setFieldError(stopLossInput, `Stop loss (₹${stopLoss}) should be < last price (₹${lastPrice})`);
                    errors.push('Stop loss too high');
                    isValid = false;
                } else {
                    setFieldSuccess(stopLossInput);
                }
            }
        }

        return isValid;
    }

    function setFieldError(field, message) {
        field.classList.add('is-invalid');
        field.classList.remove('is-valid');
        
        // Remove existing feedback
        const existingFeedback = field.parentNode.querySelector('.invalid-feedback');
        if (existingFeedback) {
            existingFeedback.remove();
        }
        
        // Add error feedback
        const feedback = document.createElement('div');
        feedback.className = 'invalid-feedback';
        feedback.textContent = message;
        field.parentNode.appendChild(feedback);
    }

    function setFieldSuccess(field) {
        field.classList.add('is-valid');
        field.classList.remove('is-invalid');
        
        // Remove existing feedback
        const existingFeedback = field.parentNode.querySelector('.invalid-feedback');
        if (existingFeedback) {
            existingFeedback.remove();
        }
    }

    function clearValidationStates() {
        [triggerPriceInput, targetPriceInput, stopLossInput].forEach(field => {
            if (field) {
                field.classList.remove('is-valid', 'is-invalid');
                const feedback = field.parentNode.querySelector('.invalid-feedback');
                if (feedback) {
                    feedback.remove();
                }
            }
        });
    }

    // Export validation function for form submission
    window.validatePrices = validatePrices;
}

function showSymbolInfo(data) {
    // Show additional information about the symbol from database vlookup
    let infoText = '';
    let infoItems = [];
    
    if (data.company_name) {
        infoItems.push(`Company: ${data.company_name}`);
    }
    
    if (data.nifty_rank) {
        infoItems.push(`Nifty Rank: ${data.nifty_rank}`);
    }
    
    if (data.mcap_lakhs) {
        const mcapCrores = (data.mcap_lakhs / 100).toFixed(0);
        infoItems.push(`Market Cap: ₹${mcapCrores} Cr`);
    }
    
    if (data.latest_price) {
        infoItems.push(`Latest Price: ₹${data.latest_price.toFixed(2)}`);
    }
    
    if (data.him_rating) {
        infoItems.push(`Rating: ${data.him_rating}`);
    }
    
    if (data.rating_date) {
        infoItems.push(`Rating Date: ${data.rating_date}`);
    }
    
    infoText = infoItems.join(' | ');
    
    // Create or update info display
    const symbolInput = document.getElementById('symbol');
    let infoDiv = document.getElementById('symbolInfo');
    if (!infoDiv) {
        infoDiv = document.createElement('div');
        infoDiv.id = 'symbolInfo';
        infoDiv.className = 'small text-info mt-1 border p-2 bg-light rounded';
        symbolInput.parentNode.appendChild(infoDiv);
    }
    
    if (infoText) {
        infoDiv.innerHTML = `<i class="fas fa-info-circle"></i> ${infoText}`;
        infoDiv.style.display = 'block';
    } else {
        infoDiv.style.display = 'none';
    }
}

function clearSymbolInfo() {
    const infoDiv = document.getElementById('symbolInfo');
    if (infoDiv) {
        infoDiv.remove();
    }
}

// Initialize auto-population and validation on page load
document.addEventListener('DOMContentLoaded', function() {
    setupSymbolAutopopulation();
    setupPriceValidation();
});
</script>

<!-- Save Filter Modal -->
<div class="modal fade" id="saveFilterModal" tabindex="-1" aria-labelledby="saveFilterModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="saveFilterModalLabel">Save Advanced Search Filter</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="saveFilterForm">
                    <div class="mb-3">
                        <label for="filterName" class="form-label">Filter Name *</label>
                        <input type="text" class="form-control" id="filterName" required 
                               placeholder="e.g. High Quantity Orders">
                    </div>
                    <div class="mb-3">
                        <label for="filterQuery" class="form-label">Filter Query *</label>
                        <textarea class="form-control" id="filterQuery" rows="2" required readonly></textarea>
                    </div>
                    <div class="mb-3">
                        <label for="filterDescription" class="form-label">Description (Optional)</label>
                        <textarea class="form-control" id="filterDescription" rows="2" 
                                  placeholder="Brief description of what this filter does"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="confirmSaveFilter">Save Filter</button>
            </div>
        </div>
    </div>
</div>

<!-- Manage Filters Modal -->
<div class="modal fade" id="manageFiltersModal" tabindex="-1" aria-labelledby="manageFiltersModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="manageFiltersModalLabel">Manage Saved Filters</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <div>
                        <button class="btn btn-sm btn-outline-primary" id="exportFilters">
                            <i class="fas fa-download me-1"></i>Export
                        </button>
                        <button class="btn btn-sm btn-outline-secondary" id="importFilters">
                            <i class="fas fa-upload me-1"></i>Import
                        </button>
                    </div>
                    <input type="file" id="importFiltersFile" accept=".json" style="display: none;">
                </div>
                <div id="filtersTableContainer">
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Query</th>
                                <th>Used</th>
                                <th>Created</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="filtersTableBody">
                            <tr>
                                <td colspan="5" class="text-center text-muted">Loading filters...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>
<script src="{{ url_for('static', filename='js/custom-gtt.js') }}"></script>
{% endblock %}