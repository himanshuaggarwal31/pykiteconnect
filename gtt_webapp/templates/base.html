<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}Kite GTT Orders Dashboard{% endblock %}</title>
    
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome Icons -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <!-- DataTables CSS -->
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.7/css/jquery.dataTables.min.css" />
    <!-- Shared Table Styling -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/shared-table.css') }}">
    <!-- Layout and Toggle Styling -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/layout.css') }}">
    <!-- Custom GTT Styling -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/custom-gtt.css') }}">
    
    <!-- JavaScript Dependencies -->
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.7/js/jquery.dataTables.min.js"></script>

    {% block extra_css %}{% endblock %}
</head>
<body>
    <div class="wrapper d-flex">
        <!-- Toggle button for sidebar -->
        <button id="toggleSidebar" class="btn btn-outline-secondary toggle-btn" title="Toggle Sidebar">
            <i class="fas fa-bars"></i>
        </button>
        
        <!-- Sidebar -->
        <nav id="sidebar" class="sidebar-nav">
            <div class="sidebar-header">
                <h3><i class="fas fa-chart-line me-2"></i>GTT Dashboard</h3>
                {% if bypass_mode %}
                <div class="mt-2">
                    <span class="badge bg-warning text-dark">
                        <i class="fas fa-unlock me-1"></i>Dev Mode
                    </span>
                </div>
                {% endif %}
            </div>

            <ul class="list-unstyled components">
                <li class="{% if request.endpoint == 'main.dashboard' %}active{% endif %}">
                    <a href="{{ url_for('main.dashboard') }}">
                        <i class="fas fa-home me-2"></i>Dashboard
                    </a>
                </li>
                <li class="{% if request.endpoint == 'main.kite_gtt_orders' %}active{% endif %}">
                    <a href="{{ url_for('main.kite_gtt_orders') }}">
                        <i class="fas fa-chart-line me-2"></i>Kite GTT Orders
                    </a>
                </li>
                <li class="{% if request.endpoint == 'holdings.index' %}active{% endif %}">
                    <a href="{{ url_for('holdings.index') }}">
                        <i class="fas fa-briefcase me-2"></i>Holdings
                    </a>
                </li>
                <li class="{% if request.endpoint == 'custom_gtt.index' %}active{% endif %}">
                    <a href="{{ url_for('custom_gtt.index') }}">
                        <i class="fas fa-layer-group me-2"></i>Custom GTT
                    </a>
                </li>
                {% if has_feature_access('custom_data') %}
                <li class="{% if request.endpoint == 'custom_data.index' %}active{% endif %}">
                    <a href="{{ url_for('custom_data.index') }}">
                        <i class="fas fa-table me-2"></i>Custom Data
                    </a>
                </li>
                {% endif %}
                {% if has_feature_access('sql_results') %}
                <li class="{% if request.endpoint == 'sql_results.index' %}active{% endif %}">
                    <a href="{{ url_for('sql_results.index') }}">
                        <i class="fas fa-database me-2"></i>SQL Results
                    </a>
                </li>
                {% endif %}
                
                <!-- Spacer to push user section to bottom -->
                <li class="flex-grow-1"></li>
                
                <!-- User Section at Bottom -->
                <li class="mt-auto pt-3" style="border-top: 1px solid rgba(255,255,255,0.1);">
                    <div class="px-3 py-2">
                        <div class="d-flex align-items-center">
                            {% if bypass_mode %}
                                <div class="bg-warning rounded-circle d-inline-flex align-items-center justify-content-center me-2" style="width: 32px; height: 32px;">
                                    <i class="fas fa-unlock text-dark"></i>
                                </div>
                            {% elif session.user_picture %}
                                <img src="{{ session.user_picture }}" class="rounded-circle me-2" width="32" height="32" alt="Profile">
                            {% else %}
                                <div class="bg-white rounded-circle d-inline-flex align-items-center justify-content-center me-2" style="width: 32px; height: 32px;">
                                    <i class="fas fa-user text-primary"></i>
                                </div>
                            {% endif %}
                            <div class="flex-grow-1">
                                {% if bypass_mode %}
                                    <div class="text-white fw-bold" style="font-size: 0.85rem;">Development User</div>
                                    <div class="text-white-50" style="font-size: 0.75rem;">Authentication Bypassed</div>
                                {% else %}
                                    <div class="text-white fw-bold" style="font-size: 0.85rem;">{{ session.user_name or 'User' }}</div>
                                    <div class="text-white-50" style="font-size: 0.75rem;">{{ session.user_email or '' }}</div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </li>
                {% if session.user_is_admin %}
                <li>
                    <a href="{{ url_for('auth.admin_users') }}">
                        <i class="fas fa-users-cog me-2"></i>Manage Users
                    </a>
                </li>
                {% endif %}
                <li>
                    <a href="{{ url_for('profile.index') }}">
                        <i class="fas fa-cog me-2"></i>Trading Config
                    </a>
                </li>
                <li>
                    <a href="{{ url_for('auth.profile') }}">
                        <i class="fas fa-user-circle me-2"></i>Profile
                    </a>
                </li>
                <li>
                    <a href="{{ url_for('auth.logout') }}" class="text-warning">
                        <i class="fas fa-sign-out-alt me-2"></i>Logout
                    </a>
                </li>
            </ul>
        </nav>

        <!-- Page Content -->
        <div id="content">
            <div class="container-fluid py-2">
                {% block content %}{% endblock %}
            </div>
        </div>
        
        <!-- Mobile overlay -->
        <div id="sidebarOverlay" class="sidebar-overlay"></div>
    </div>

    <!-- Load Bootstrap JS first so it's available for other scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Sidebar Toggle Script -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const toggleBtn = document.getElementById('toggleSidebar');
            const sidebar = document.getElementById('sidebar');
            const content = document.getElementById('content');
            const overlay = document.getElementById('sidebarOverlay');
            const body = document.body;
            
            // Check if we're on mobile
            function isMobile() {
                return window.innerWidth <= 768;
            }
            
            // Load saved state from localStorage
            function loadSidebarState() {
                const savedState = localStorage.getItem('sidebarVisible');
                if (savedState !== null) {
                    const isVisible = savedState === 'true';
                    setSidebarState(isVisible, false); // false = no animation on load
                } else {
                    // Default state: visible on desktop, hidden on mobile
                    setSidebarState(!isMobile(), false);
                }
            }
            
            // Set sidebar state
            function setSidebarState(isVisible, animate = true) {
                if (animate) {
                    sidebar.style.transition = 'transform 0.3s ease';
                    content.style.transition = 'margin-left 0.3s ease';
                    toggleBtn.classList.add('transitioning');
                } else {
                    sidebar.style.transition = 'none';
                    content.style.transition = 'none';
                    toggleBtn.classList.remove('transitioning');
                }
                
                if (isVisible) {
                    sidebar.classList.remove('hidden');
                    if (!isMobile()) {
                        content.classList.remove('expanded');
                    }
                    body.classList.add('sidebar-visible');
                    body.classList.remove('sidebar-hidden');
                    
                    // Update toggle button icon
                    toggleBtn.innerHTML = '<i class="fas fa-chevron-left"></i>';
                    toggleBtn.title = 'Hide Sidebar';
                    
                    if (isMobile()) {
                        sidebar.classList.add('show');
                        overlay.classList.add('show');
                    }
                } else {
                    sidebar.classList.add('hidden');
                    content.classList.add('expanded');
                    body.classList.add('sidebar-hidden');
                    body.classList.remove('sidebar-visible');
                    
                    // Update toggle button icon
                    toggleBtn.innerHTML = '<i class="fas fa-bars"></i>';
                    toggleBtn.title = 'Show Sidebar';
                    
                    if (isMobile()) {
                        sidebar.classList.remove('show');
                        overlay.classList.remove('show');
                    }
                }
                
                // Save state to localStorage
                localStorage.setItem('sidebarVisible', isVisible.toString());
                
                // Restore transition after animation completes
                if (!animate) {
                    setTimeout(() => {
                        sidebar.style.transition = '';
                        content.style.transition = '';
                        toggleBtn.classList.remove('transitioning');
                    }, 50);
                } else {
                    setTimeout(() => {
                        toggleBtn.classList.remove('transitioning');
                    }, 300);
                }
            }
            
            // Toggle sidebar
            function toggleSidebar() {
                const isCurrentlyVisible = !sidebar.classList.contains('hidden');
                setSidebarState(!isCurrentlyVisible);
            }
            
            // Event listeners
            toggleBtn.addEventListener('click', toggleSidebar);
            
            // Close sidebar when clicking overlay (mobile)
            overlay.addEventListener('click', function() {
                if (isMobile()) {
                    setSidebarState(false);
                }
            });
            
            // Handle window resize
            let resizeTimeout;
            window.addEventListener('resize', function() {
                clearTimeout(resizeTimeout);
                resizeTimeout = setTimeout(function() {
                    const wasVisible = !sidebar.classList.contains('hidden');
                    
                    if (isMobile()) {
                        // On mobile, always hide initially and remove desktop margins
                        content.classList.add('expanded');
                        if (wasVisible) {
                            sidebar.classList.add('show');
                            overlay.classList.add('show');
                        }
                    } else {
                        // On desktop, restore proper margins and hide overlay
                        sidebar.classList.remove('show');
                        overlay.classList.remove('show');
                        if (wasVisible) {
                            content.classList.remove('expanded');
                        }
                    }
                }, 250);
            });
            
            // Keyboard accessibility
            document.addEventListener('keydown', function(e) {
                // Toggle sidebar with Ctrl/Cmd + B
                if ((e.ctrlKey || e.metaKey) && e.key === 'b') {
                    e.preventDefault();
                    toggleSidebar();
                }
                
                // Close sidebar with Escape key (mobile)
                if (e.key === 'Escape' && isMobile() && !sidebar.classList.contains('hidden')) {
                    setSidebarState(false);
                }
            });
            
            // Initialize sidebar state
            loadSidebarState();
        });
    </script>
    
    {% block scripts %}{% endblock %}
</body>
</html>
