<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug SQL GTT API</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        pre {
            background: #f4f4f4;
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 10px;
            white-space: pre-wrap;
        }
        
        .response-container {
            margin-top: 20px;
            min-height: 100px;
            max-height: 400px;
            overflow-y: auto;
        }
        
        .btn-row {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }
    </style>
</head>
<body>
    <div class="container mt-4">
        <h1>SQL GTT API Debug Tool</h1>
        
        <div class="card mb-4">
            <div class="card-header">
                <h3>Check Order Exists</h3>
            </div>
            <div class="card-body">
                <form id="checkOrderForm">
                    <div class="row mb-3">
                        <div class="col-md-4">
                            <label for="symbol" class="form-label">Symbol</label>
                            <input type="text" class="form-control" id="symbol" value="INFY">
                        </div>
                        <div class="col-md-4">
                            <label for="orderType" class="form-label">Order Type</label>
                            <select class="form-control" id="orderType">
                                <option value="BUY">BUY</option>
                                <option value="SELL">SELL</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label for="triggerType" class="form-label">Trigger Type</label>
                            <select class="form-control" id="triggerType">
                                <option value="single">single</option>
                                <option value="two-leg">two-leg</option>
                            </select>
                        </div>
                    </div>
                    <div class="btn-row">
                        <button type="button" class="btn btn-primary" id="checkOrderBtn">
                            Check Order
                        </button>
                        <button type="button" class="btn btn-success" id="getLastPriceBtn">
                            Get Last Price
                        </button>
                    </div>
                </form>
                
                <div class="response-container">
                    <h5>Response:</h5>
                    <pre id="checkOrderResponse">No response yet</pre>
                </div>
            </div>
        </div>
        
        <div class="card mb-4">
            <div class="card-header">
                <h3>Create New Order</h3>
            </div>
            <div class="card-body">
                <form id="createOrderForm">
                    <div class="row mb-3">
                        <div class="col-md-4">
                            <label for="createSymbol" class="form-label">Symbol</label>
                            <input type="text" class="form-control" id="createSymbol" value="INFY">
                        </div>
                        <div class="col-md-4">
                            <label for="createCompanyName" class="form-label">Company Name</label>
                            <input type="text" class="form-control" id="createCompanyName" value="Infosys Ltd.">
                        </div>
                        <div class="col-md-4">
                            <label for="createNiftyRank" class="form-label">Nifty Rank</label>
                            <input type="number" class="form-control" id="createNiftyRank" value="50">
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-4">
                            <label for="createOrderType" class="form-label">Order Type</label>
                            <select class="form-control" id="createOrderType">
                                <option value="BUY">BUY</option>
                                <option value="SELL">SELL</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label for="createTriggerType" class="form-label">Trigger Type</label>
                            <select class="form-control" id="createTriggerType">
                                <option value="single">single</option>
                                <option value="two-leg">two-leg</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label for="createQuantity" class="form-label">Quantity</label>
                            <input type="number" class="form-control" id="createQuantity" value="1">
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-4">
                            <label for="createLastPrice" class="form-label">Last Price</label>
                            <input type="number" class="form-control" id="createLastPrice" value="1500" step="0.01">
                        </div>
                        <div class="col-md-4">
                            <label for="createTriggerPrice" class="form-label">Trigger Price</label>
                            <input type="number" class="form-control" id="createTriggerPrice" value="1350" step="0.01">
                        </div>
                        <div class="col-md-4">
                            <label for="createTargetPrice" class="form-label">Target Price</label>
                            <input type="number" class="form-control" id="createTargetPrice" value="1950" step="0.01">
                        </div>
                    </div>
                    <button type="button" class="btn btn-primary" id="createOrderBtn">
                        Create New Order
                    </button>
                </form>
                
                <div class="response-container">
                    <h5>Response:</h5>
                    <pre id="createOrderResponse">No response yet</pre>
                </div>
            </div>
        </div>

        <div class="card mb-4">
            <div class="card-header">
                <h3>Network Log</h3>
            </div>
            <div class="card-body">
                <div class="response-container">
                    <pre id="networkLog">No network activity yet</pre>
                    <button type="button" class="btn btn-secondary" id="clearLogBtn">Clear Log</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Helper function to log network activity
        function logNetwork(method, url, requestData, responseData, status) {
            const logElement = document.getElementById('networkLog');
            const timestamp = new Date().toLocaleTimeString();
            
            let logMessage = `${timestamp} - ${method} ${url} (Status: ${status})\n`;
            logMessage += `Request: ${JSON.stringify(requestData, null, 2)}\n`;
            logMessage += `Response: ${JSON.stringify(responseData, null, 2)}\n`;
            logMessage += '---------------------------------------------------\n\n';
            
            logElement.textContent = logMessage + logElement.textContent;
        }
        
        // Check if order exists
        document.getElementById('checkOrderBtn').addEventListener('click', function() {
            const symbol = document.getElementById('symbol').value;
            const orderType = document.getElementById('orderType').value;
            const triggerType = document.getElementById('triggerType').value;
            const responseElement = document.getElementById('checkOrderResponse');
            
            responseElement.textContent = 'Loading...';
            
            const requestData = {
                symbol: symbol,
                order_type: orderType,
                trigger_type: triggerType
            };
            
            fetch('/api/sql-results-gtt/add-gtt-order', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(requestData)
            })
            .then(response => {
                const status = response.status;
                return response.json().then(data => {
                    return { data, status };
                });
            })
            .then(({ data, status }) => {
                responseElement.textContent = JSON.stringify(data, null, 2);
                logNetwork('POST', '/api/sql-results-gtt/add-gtt-order', requestData, data, status);
            })
            .catch(error => {
                responseElement.textContent = `Error: ${error.message}`;
                logNetwork('POST', '/api/sql-results-gtt/add-gtt-order', requestData, { error: error.message }, 'Error');
            });
        });
        
        // Get last price
        document.getElementById('getLastPriceBtn').addEventListener('click', function() {
            const symbol = document.getElementById('symbol').value;
            const responseElement = document.getElementById('checkOrderResponse');
            
            responseElement.textContent = 'Loading...';
            
            fetch(`/api/sql-results-gtt/get-last-price?symbol=${encodeURIComponent(symbol)}`)
            .then(response => {
                const status = response.status;
                return response.json().then(data => {
                    return { data, status };
                });
            })
            .then(({ data, status }) => {
                responseElement.textContent = JSON.stringify(data, null, 2);
                logNetwork('GET', `/api/sql-results-gtt/get-last-price?symbol=${symbol}`, {}, data, status);
            })
            .catch(error => {
                responseElement.textContent = `Error: ${error.message}`;
                logNetwork('GET', `/api/sql-results-gtt/get-last-price?symbol=${symbol}`, {}, { error: error.message }, 'Error');
            });
        });
        
        // Create new order
        document.getElementById('createOrderBtn').addEventListener('click', function() {
            const responseElement = document.getElementById('createOrderResponse');
            responseElement.textContent = 'Loading...';
            
            const requestData = {
                symbol: document.getElementById('createSymbol').value,
                company_name: document.getElementById('createCompanyName').value,
                nifty_rank: document.getElementById('createNiftyRank').value,
                order_type: document.getElementById('createOrderType').value,
                trigger_type: document.getElementById('createTriggerType').value,
                quantity: document.getElementById('createQuantity').value,
                last_price: document.getElementById('createLastPrice').value,
                trigger_price: document.getElementById('createTriggerPrice').value,
                target_price: document.getElementById('createTargetPrice').value,
                exchange: 'NSE',
                is_active: 1,
                placed_on_kite: 0
            };
            
            fetch('/api/custom-gtt/save-order', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(requestData)
            })
            .then(response => {
                const status = response.status;
                return response.json().then(data => {
                    return { data, status };
                });
            })
            .then(({ data, status }) => {
                responseElement.textContent = JSON.stringify(data, null, 2);
                logNetwork('POST', '/api/custom-gtt/save-order', requestData, data, status);
            })
            .catch(error => {
                responseElement.textContent = `Error: ${error.message}`;
                logNetwork('POST', '/api/custom-gtt/save-order', requestData, { error: error.message }, 'Error');
            });
        });
        
        // Clear log
        document.getElementById('clearLogBtn').addEventListener('click', function() {
            document.getElementById('networkLog').textContent = 'Network log cleared';
        });
    </script>
</body>
</html>
